#!/usr/bin/env bash
set -u

stdout_file="$(mktemp)"
stderr_file="$(mktemp)"
start_time="$(date +%s.%N)"

"$@" > >(tee "${stdout_file}") 2> >(tee "${stderr_file}" >&2)

exit_code="$?"
end_time="$(date +%s.%N)"

runtime_seconds=$(echo "${end_time} - ${start_time}" | bc -l)
runtime=$(date -d@0"${runtime_seconds}" -u +%H:%M:%S.%N | head -c 10)

function cat_file_compact() {
  [[ $# -ne 1 ]] && return 1
  file_path="$1"
  if [[ $(wc -l < "${file_path}") -gt 8 ]]; then
    head -n 4 "${file_path}" \
      && echo "..." \
      && tail -n 4 "${file_path}"
  else
    head "${file_path}"
  fi
}
export -f cat_file_compact
stdout="$(cat_file_compact "${stdout_file}")"
stderr="$(cat_file_compact "${stderr_file}")"
rm --force "${stdout_file}" "${stderr_file}"

notify-send "Finished [${exit_code}] after ${runtime}" "\$ $*
${stdout}
${stderr}
"

exit "${exit_code}"
