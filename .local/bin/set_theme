#!/usr/bin/env bash
set -euo pipefail

function help_and_exit() {
    echo "usage:$0 [dark/light/reset]"
    exit 1
}

function set_gtk4_theme() {
    dark_or_light="$1"
    if [[ "${dark_or_light}" == "dark" ]]; then
        theme_name="Adwaita-dark"
    else
        theme_name="Adwaita"
    fi
    gsettings set org.gnome.desktop.interface gtk-theme "${theme_name}"
    gsettings set org.gnome.desktop.interface color-scheme prefer-"${dark_or_light}"
}

function reset_gtk4_theme() {
    gsettings reset org.gnome.desktop.interface gtk-theme
    gsettings reset org.gnome.desktop.interface color-scheme
}

function set_kitty_theme() {
    dark_or_light="$1"
    kitty_config_dir="${HOME}"/.config/kitty
    ln --symbolic --relative --force "${kitty_config_dir}"/theme_"${dark_or_light}".conf "${kitty_config_dir}"/theme.conf
}

function reset_kitty_theme() {
    kitty_config_dir="${HOME}"/.config/kitty
    rm --force "${kitty_config_dir}"/theme.conf
}

function init_gtk3_settings() {
    gtk3_settings_dir="${HOME}"/.config/gtk-3.0
    mkdir --parents "${gtk3_settings_dir}"
    gtk3_settings_path="${gtk3_settings_dir}"/settings.ini
    if [[ ! -f "${gtk3_settings_path}" ]]; then
        echo "[Settings]" >"${gtk3_settings_path}"
    fi
    echo "${gtk3_settings_path}"
}

function set_gtk3_theme() {
    dark_or_light="$1"
    if [[ "${dark_or_light}" == "dark" ]]; then
        is_dark="true"
    else
        is_dark="false"
    fi
    gtk3_settings_path="$(init_gtk3_settings)"

    settings_key="gtk-application-prefer-dark-theme"
    settings_pattern="^#?\s?(${settings_key})\s*=\s*[a-z]*$"
    if grep --quiet --extended-regexp "${settings_pattern}" "${gtk3_settings_path}"; then
        sed --in-place --regexp-extended "s/${settings_pattern}/\1 = ${is_dark}/g" "${gtk3_settings_path}"
    else
        echo "gtk-application-prefer-dark-theme = ${is_dark}" >>"${gtk3_settings_path}"
    fi
}

function reset_gtk3_theme() {
    gtk3_settings_path="$(init_gtk3_settings)"
    settings_key="gtk-application-prefer-dark-theme"
    settings_pattern="^#?\s?(${settings_key}\s*=\s*[a-z]*)$"
    sed --in-place --regexp-extended "s/${settings_pattern}/# \1/g" "${gtk3_settings_path}"
}

function set_nvim_theme() {
    dark_or_light="$1"
    nvim_config_dir="${HOME}"/.config/nvim
    mkdir --parents "${nvim_config_dir}"
    echo "${dark_or_light}" >"${nvim_config_dir}"/theme.txt
}

function reset_nvim_theme() {
    rm --force "${HOME}"/.config/nvim/theme.txt
}

function set_theme() {
    dark_or_light="$1"
    set_kitty_theme "${dark_or_light}"
    set_nvim_theme "${dark_or_light}"
    set_gtk3_theme "${dark_or_light}"
    set_gtk4_theme "${dark_or_light}"
}

function reset_theme() {
    reset_kitty_theme
    reset_nvim_theme
    reset_gtk3_theme
    reset_gtk4_theme
}

function main() {
    if [[ "$#" -ne 1 ]]; then
        help_and_exit
    fi
    theme="$1"
    case "${theme}" in
    light)
        set_theme "light"
        ;;
    dark)
        set_theme "dark"
        ;;
    reset)
        reset_theme
        ;;
    *)
        help_and_exit
        ;;
    esac

}

if [[ "$#" -ne 1 ]] || [[ "${1}" != "--source-only" ]]; then
    main "${@}"
fi
